<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <th:block th:replace="/layout/header :: header"/>
    <title>Dashboard | Uplon - Responsive Bootstrap 4 Admin Dashboard</title>

</head>

<body>

<!-- Begin page -->
<div id="wrapper">


    <!-- Topbar Start -->
    <th:block th:replace="/layout/navbar/navbar :: navbar"/>


    <!-- ========== Left Sidebar Start ========== -->
    <th:block th:replace="/layout/left-side-bar :: left-side-menu"/>
    <!-- Left Sidebar End -->

    <!-- ============================================================== -->
    <!-- Start Page Content here -->
    <!-- ============================================================== -->

    <div class="content-page">
        <div class="content">

            <!-- Start Content-->
            <div class="container-fluid">

                <!-- start page title -->
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-box">
                            <div class="page-title-right">
                                <ol class="breadcrumb m-0">
                                    <li class="breadcrumb-item"><a href="javascript: void(0);">Uplon</a></li>
                                    <li class="breadcrumb-item active">User</li>
                                </ol>
                            </div>
                            <h4 class="page-title">User</h4>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-8 float-lg-left">
                        <h2>List User</h2>
                    </div>
                    <div class="col-4 float-lg-right">
                        <button type="button" style="margin-bottom: 10px" id="modalAdd"
                                class="btn btn-outline-primary float-right  modalAdd">
                            <i class="fa fa-plus" aria-hidden="true"></i>
                            Create User
                        </button>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-12">
                        <table id="tableListUsers" class="table table-hover">
                            <thead class="thead-dark">
                            <tr>
                                <th class="align-middle text-center ">img</th>
                                <th class="align-middle text-center ">#</th>
                                <th class="align-middle text-center ">EMAIL</th>
                                <th class="align-middle text-center ">ROLE</th>
                                <th class="align-middle text-center ">STATUS</th>
                                <th class="align-middle text-center " colspan="4">ACTION</th>
                            </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- end container-fluid -->

        </div> <!-- end content -->


        <!-- Footer Start -->
        <footer class="footer">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-12">
                        2016 - 2019 &copy; Uplon theme by <a href="">Coderthemes</a>
                    </div>
                </div>
            </div>
        </footer>
        <!-- end Footer -->

    </div>

    <!-- ============================================================== -->
    <!-- End Page content -->
    <!-- ============================================================== -->

</div>

<th:block th:replace="/layout/script/script :: script"/>

<th:block th:replace="/user/modal-change-password :: modal-change-password"/>

<th:block th:replace="/user/modal-create-information :: modal-create-information"/>

<th:block th:replace="/user/modal_update_information :: modal-update-information"/>

<script>

    let user = new User();

    let role = new Role();

    let userId = null;

    function LoadingAllUser() {
        $.ajax({
            "type": "GET",
            "url": "http://localhost:8080/api/user"
        }).done((data) => {
            console.log(data)
            $.each(data, (i, item) => {
                console.log(item.role.code);
                let strActive = `<button data-id="${item.id}" style="margin-right: 10px" class="btn btn-outline-success btn-active">Active</button>`;
                let strBlock = `<button class="btn btn-outline-danger btn-blockk" data-id="${item.id}">Block</button>`;
                let str = `
                     <tr id="tr_${item.id}">
                        <td class="align-middle text-center "><img src="${item.image}"style="border-radius: 50%" width="80px" alt=""></td>
                        <td class="align-middle text-center ">${item.id}</td>
                        <td class="align-middle text-center ">${item.username}</td>
                        <td class="align-middle text-center "><b>${item.role.code}</b></td>
                        <td class="align-middle text-center "><b>${item.status}</b></td>
                        <td class="align-middle text-center ">
                            ${item.status === 'Active' ? strBlock : strActive}
                            <button type="button" data-id="${item.id}" class="btn btn-outline-warning btnChangePassWord">
                               New Password
                            </button>
                            <button class="btn btn-outline-danger btn-updateRemaining" data-id="${item.id}">Update Remaining</button>
                        </td>
                    </tr>
                `
                $('#tableListUsers tbody').prepend(str);
            })

            // <button data-id="${item.id}" style="margin-right: 10px"
            // className="btn btn-outline-success btn-active">Active</button>
            // <button className="btn btn-outline-danger btn-block" data-id="${item.id}">block</button>

            groupHandle();

        }).fail((jqXHR) => {
            console.log(jqXHR)
        })
    }

    function getUserById(userId) {
        return $.ajax({
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            "type": "GET",
            url: "http://localhost:8080/api/user/" + userId
        }).done((data) => {
            user = data;
        }).fail((jqXHR) => {
            App.SweetAlert.showErrorAlert("fail id customer");
            console.log(jqXHR);
        })
    }

    $("#btnCreate").on("click", function () {
        $("#frmCreateCustomer").submit();
    })

    $("#btnUpdatePassword").on("click", () => {
        $("#frmUpdatePassword").submit();
    })

    $("#btnUpdateInformation").on("click", () => {
        $("#frmUpdateFullInformation").submit();
    })

    function handleShowCreateModal() {
        $("#modalAdd").on("click", () => {
            $("#modalCreateUser").modal('show');
        })
    }

    function handleShowUpdatePassWord() {
        $(".btnChangePassWord").on("click", function () {
            let id = $(this).data("id");
            getUserById(id).then(() => {
                $("#modalUpdatePassword").modal("show");
                $("#idUser").val(user.id);
            })
        })
    }

    function handleShowUpdateRemaining() {
        $(".btn-updateRemaining").on("click", function () {
            let id = $(this).data("id");
            getUserById(id).then(() => {
                $("#modalUpdateFullUser").modal("show");
                $("#idUserUp").val(user.id);
                $("#imageUp").val(user.image);
                $("#EmailUp").val(user.username);
            })
        })
    }

    function handleActive() {
        $(".btn-active").on("click", function () {
            let id = $(this).data("id");
            getUserById(id).then(() => {
                $.ajax({
                    headers: {
                        "accept": "application/json",
                        "content-type": "application/json"
                    },
                    type: "PUT",
                    url: "http://localhost:8080/api/user/active",
                    data: JSON.stringify(user)
                }).done((item) => {
                    user = item;
                    let currentRow = $('#tr_' + user.id);

                    let strActive = `<button data-id="${item.id}" style="margin-right: 10px" class="btn btn-outline-success btn-active">Active</button>`;
                    let strBlock = `<button class="btn btn-outline-danger btn-blockk" data-id="${item.id}">Block</button>`;
                    let updateRow = `
                     <tr id="tr_${item.id}">
                        <td class="align-middle text-center "><img src="${item.image}"style="border-radius: 50%" width="80px" alt=""></td>
                        <td class="align-middle text-center ">${item.id}</td>
                        <td class="align-middle text-center ">${item.username}</td>
                        <td class="align-middle text-center "><b>${item.role.code}</b></td>
                        <td class="align-middle text-center "><b>${item.status}</b></td>
                        <td class="align-middle text-center ">
                            ${item.status === 'Active' ? strBlock : strActive}
                            <button type="button" data-id="${item.id}" class="btn btn-outline-primary btnChangePassWord">
                               New Password
                            </button>
                            <button class="btn btn-outline-danger btn-updateRemaining" data-id="${item.id}">Update Remaining</button>
                        </td>
                    </tr>
                    `
                    App.IziToast.showSuccessAlert("Tài Khoản đã được Active!");
                    currentRow.replaceWith(updateRow);
                    unBindAll()
                    groupHandle()
                }).fail((jqXHR) => {
                    console.log(jqXHR)
                })
            })
        })
    }

    function handleBlock() {
        $(".btn-blockk").on("click", function () {
            let id = $(this).data("id");
            getUserById(id).then(() => {
                $.ajax({
                    headers: {
                        "accept": "application/json",
                        "content-type": "application/json"
                    },
                    type: "PUT",
                    url: "http://localhost:8080/api/user/block",
                    data: JSON.stringify(user)
                }).done((item) => {
                    user = item;
                    let currentRow = $('#tr_' + user.id);
                    let strActive = `<button data-id="${item.id}" style="margin-right: 10px" class="btn btn-outline-success btn-active">Active</button>`;
                    let strBlock = `<button class="btn btn-outline-danger btn-blockk" data-id="${item.id}">block</button>`;
                    let updateRow = `
                     <tr id="tr_${item.id}">
                        <td class="align-middle text-center "><img src="${item.image}"style="border-radius: 50%" width="80px" alt=""></td>
                        <td class="align-middle text-center ">${item.id}</td>
                        <td class="align-middle text-center ">${item.username}</td>
                        <td class="align-middle text-center "><b>${item.role.code}</b></td>
                        <td class="align-middle text-center "><b>${item.status}</b></td>
                        <td class="align-middle text-center ">
                            ${item.status === 'Active' ? strBlock : strActive}
                            <button type="button" data-id="${item.id}" class="btn btn-outline-primary btnChangePassWord">
                               New Password
                            </button>
                            <button class="btn btn-outline-danger btn-updateRemaining" data-id="${item.id}">Update Remaining</button>
                        </td>
                    </tr>
                    `
                    App.IziToast.showSuccessAlert("Tài khoản đã bị block");
                    currentRow.replaceWith(updateRow);
                    unBindAll()
                    groupHandle()
                }).fail((jqXHR) => {
                    // $('#modalCreateUser .modal-alert-danger ').html('').removeClass('hide').addClass('show');
                    // if (jqXHR.responseJSON) {
                    //     let str = '';
                    //     $.each(jqXHR.responseJSON, (key, item) => {
                    //         str += `<label for="${key}" id="${key}-error" class="error">${item}</label><br>`;
                    //         $('#modalCreateUser .modal-alert-danger').append(str);
                    //     })
                    // }
                    console.log(jqXHR)
                })
            })
        })
    }

    function doCreate() {
        let username = $("#EmailCre").val();
        let passwordCre = $("#passwordCre").val();
        let roleCode = $("#role :selected").text();
        let roleId = $("#role").val();

        role.id = roleId;
        role.code = roleCode;

        delete user.id
        user.username = username;
        user.password = passwordCre;
        user.role = role;
        user.image = $("#imageCre").val()
        $.ajax({
            headers: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            type: "POST",
            url: "http://localhost:8080/api/auth/register",
            data: JSON.stringify(user)
        }).done((item) => {
            $("#modalCreateUser").modal('hide');
            App.SweetAlert.showSuccessAlert("Đăng ký thành công!!");

            let strActive = `<button data-id="${item.id}" style="margin-right: 10px" class="btn btn-outline-success btn-active">Active</button>`;
            let strBlock = `<button class="btn btn-outline-danger btn-blockk" data-id="${item.id}">block</button>`;
            let str = `
                     <tr id="tr_${item.id}">
                        <td class="align-middle text-center "><img src="${item.image}"style="border-radius: 50%" width="80px" alt=""></td>
                        <td class="align-middle text-center ">${item.id}</td>
                        <td class="align-middle text-center ">${item.username}</td>
                        <td class="align-middle text-center "><b>${item.role.code}</b></td>
                        <td class="align-middle text-center "><b>${item.status}</b></td>
                        <td class="align-middle text-center ">
                            ${item.status === 'Active' ? strBlock : strActive}
                            <button type="button" data-id="${item.id}" class="btn btn-outline-primary btnChangePassWord">
                               New Password
                            </button>
                            <button class="btn btn-outline-danger btn-updateRemaining" data-id="${item.id}">Update Remaining</button>
                        </td>
                    </tr>
                    `
            $('#tableListUsers tbody').prepend(str);
            $("#EmailCre").val("")
            $("#passwordCre").val("")
            $("#passwordConCre").val()
            unBindAll()
            groupHandle()

        }).fail((jqXHR) => {
            $('#modalCreateUser .modal-alert-danger ').html('').removeClass('hide').addClass('show');
            if (jqXHR.responseJSON) {
                let str = '';
                $.each(jqXHR.responseJSON, (key, item) => {
                    str = `<p><label for="${key}" id="${key}-error" class="error">${item}</label></p>`;
                    $('#modalCreateUser .modal-alert-danger').append(str);
                })
            }
        })
    }

    function doUpdateRemaining() {
        role.id = $("#roleUp").val()
        role.code = $("#roleUp :selected").text()

        user.username = $("#EmailUp").val();
        user.id = $("#idUserUp").val();
        user.image = $("#imageUp").val();
        user.role = role
        $.ajax({
            headers: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            type: "PUT",
            url: "http://localhost:8080/api/user/update/all",
            data: JSON.stringify(user)
        }).done((item) => {
            $("#modalUpdateFullUser").modal("hide");
            user = item;
            let currentRow = $('#tr_' + user.id);
            let strActive = `<button data-id="${item.id}" style="margin-right: 10px" class="btn btn-outline-success btn-active">Active</button>`;
            let strBlock = `<button class="btn btn-outline-danger btn-blockk" data-id="${item.id}">block</button>`;
            let updateRow = `
                     <tr id="tr_${item.id}">
                        <td class="align-middle text-center "><img src="${item.image}"style="border-radius: 50%" width="80px" alt=""></td>
                        <td class="align-middle text-center ">${item.id}</td>
                        <td class="align-middle text-center ">${item.username}</td>
                        <td class="align-middle text-center "><b>${item.role.code}</b></td>
                        <td class="align-middle text-center "><b>${item.status}</b></td>
                        <td class="align-middle text-center ">
                            ${item.status === 'Active' ? strBlock : strActive}
                            <button type="button" data-id="${item.id}" class="btn btn-outline-primary btnChangePassWord">
                                New Password
                            </button>
                            <button class="btn btn-outline-danger btn-updateRemaining" data-id="${item.id}">Update Remaining</button>
                        </td>
                    </tr>
                    `
            App.IziToast.showSuccessAlert("Update thành công");
            currentRow.replaceWith(updateRow);
            unBindAll()
            groupHandle()
        }).fail((jqXHR) => {
            $('#modalUpdateFullUser .modal-alert-danger').html('').removeClass('hide').addClass('show');
            if (jqXHR.responseJSON) {
                let str = '';
                $.each(jqXHR.responseJSON, (key, item) => {
                    str = `<p><label for="${key}" id="${key}-error" class="error">${item}</label><br></p>`;
                    $('#modalUpdateFullUser .modal-alert-danger').append(str);
                })
            }
        })
    }

    function doUpdatePassword() {
        let password = $("#passwordUp").val();

        user.id = $("#idUser").val();
        user.password = password;
        $.ajax({
            headers: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            type: "PUT",
            url: "http://localhost:8080/api/user/update",
            data: JSON.stringify(user)
        }).done(() => {
            App.SweetAlert.showSuccessAlert("Bạn đã đổi mật khẩu thành công!!")
        }).fail((jqXHR) => {
            $('#modalUpdatePassword .modal-alert-danger').html('').removeClass('hide').addClass('show');
            if (jqXHR.responseJSON) {
                let str = '';
                $.each(jqXHR.responseJSON, (key, item) => {
                    str = `<p><label for="${key}" id="${key}-error" class="error">${item}</label><br></p>`;
                    $('#modalUpdatePassword .modal-alert-danger').append(str);
                })
            }
        })
    }

    $('#frmCreateCustomer').validate({
        "rules": {
            "EmailCre": {
                required: true,
                email: true,
                minlength: 3,
                maxlength: 50,
            },
            "passwordCre": {
                required: true,
                minlength: 6,
                maxlength: 30,
            },
            "passwordConCre": {
                required: true,
                equalTo: "#passwordCre",
                minlength: 6,
                maxlength: 30,
            }
        },
        "messages": {
            "EmailCre": {
                required: "vui lòng nhập Email!",
                email: "Vui lòng nhập đúng định dạng Email (VD: phucnguyen@gmail.com)!",
                minlength: $.validator.format("Email tối thiểu {0} ký tự!"),
                maxlength: $.validator.format("Email tối đa {0} ký tự"),
            },
            "passwordCre": {
                required: "Vui lòng nhập Password",
                minlength: $.validator.format("Password tối thiểu {0} ký tự!"),
                maxlength: $.validator.format("Password tối đa {0} ký tự!"),
            }
            ,
            "passwordConCre": {
                required: "Vui lòng nhập Password Confirm",
                equalTo: "Mật khẩu phải giống nhau",
                minlength: $.validator.format("Password tối thiểu {0} ký tự!"),
                maxlength: $.validator.format("Password tối đa {0} ký tự!"),
            }
        },
        errorLabelContainer: "#modalCreateUser .modal-alert-danger",
        errorPlacment: function (error, element) {
            error.appendTo("#modalCreateUser .modal-alert-danger")
        },
        showErrors: function (errorMap, errorList) {
            if (this.numberOfInvalids() > 0) {
                $("#modalCreateUser .modal-alert-danger").removeClass("hide").addClass("show");
            } else {
                $("#modalCreateUser .modal-alert-danger").removeClass("show").addClass("hide").empty();
                $("#frmCreateCustomer .input.error").removeClass("error");
            }
            this.defaultShowErrors();
        },
        submitHandler: function () {
            doCreate();
        }
    })

    $('#frmUpdatePassword').validate({
        "rules": {
            "passwordUp": {
                required: true,
                minlength: 3,
                maxlength: 50,
            },
            "passwordConUp": {
                required: true,
                equalTo: "#passwordUp",
                minlength: 6,
                maxlength: 50,
            }
        },
        "messages": {
            "passwordUp": {
                required: "Vui lòng nhập Password!",
                minlength: $.validator.format("Password tối thiểu {0} ký tự!"),
                maxlength: $.validator.format("Password tối đa {0} ký tự"),
            },
            "passwordConUp": {
                required: "Vui lòng nhập Password Confirm",
                equalTo: "Mật khẩu phải giống nhau",
                minlength: $.validator.format("Password Confirm tối thiểu {0} ký tự!"),
                maxlength: $.validator.format("Password Confirm tối đa {0} ký tự!"),
            }
        },
        errorLabelContainer: "#modalUpdatePassword .modal-alert-danger",
        errorPlacment: function (error, element) {
            error.appendTo("#modalUpdatePassword .modal-alert-danger")
        },
        showErrors: function (errorMap, errorList) {
            if (this.numberOfInvalids() > 0) {
                $("#modalUpdatePassword .modal-alert-danger").removeClass("hide").addClass("show");
            } else {
                $("#modalUpdatePassword .modal-alert-danger").removeClass("show").addClass("hide").empty();
                $("#frmUpdatePassword .input.error").removeClass("error");
            }
            this.defaultShowErrors();
        },
        submitHandler: function () {
            doUpdatePassword();
        }
    })

    $('#frmUpdateFullInformation').validate({
        "rules": {
            "imageUp": {
                required: true,
            }
        },
        "messages": {
            "imageUp": {
                required: "Vui lòng nhập Ảnh!",

            }
        },
        errorLabelContainer: "#modalUpdateFullUser .modal-alert-danger",
        errorPlacment: function (error, element) {
            error.appendTo("#modalUpdateFullUser .modal-alert-danger")
        },
        showErrors: function (errorMap, errorList) {
            if (this.numberOfInvalids() > 0) {
                $("#modalUpdateFullUser .modal-alert-danger").removeClass("hide").addClass("show");
            } else {
                $("#modalUpdateFullUser .modal-alert-danger").removeClass("show").addClass("hide").empty();
                $("#frmUpdateFullInformation .input.error").removeClass("error");
            }
            this.defaultShowErrors();
        },
        submitHandler: function () {
            doUpdateRemaining();
        }
    })


    function getUserByUserName() {
        return $.ajax({
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            "type": "GET",
            url: "http://localhost:8080/api/user/name/" + $("#ursernameLoFirst").text()
        }).done((data) => {
            user = data;
            let str = `
                <img src="${data.image}" alt="user-image"  class="rounded-circle">
                <span class="d-none d-sm-inline-block ml-1 font-weight-medium" id="ursernameLoFirst" >${data.username}</span>
            `
            $("#setImageUser").append(str);
        }).fail((jqXHR) => {
            App.SweetAlert.showErrorAlert("fail user customer");
            console.log(jqXHR);
        })
    }


    function groupHandle() {
        handleShowUpdatePassWord()
        handleShowCreateModal()
        handleActive();
        handleBlock();
        handleShowUpdateRemaining()
    }

    function unBindAll() {
        $(".btn-block").off();
        $(".btn-active").off();
        $(".btn-updateRemaining").off();
        $(".btnChangePassWord").off();
    }

    groupHandle()
    LoadingAllUser();
    getUserByUserName()
</script>

</body>
</html>