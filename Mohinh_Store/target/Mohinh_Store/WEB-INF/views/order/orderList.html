<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <th:block th:replace="/layout/header :: header"/>
    <title>Dashboard | Uplon - Responsive Bootstrap 4 Admin Dashboard</title>

</head>


<body>

<!-- Begin page -->
<div id="wrapper">


    <!-- Topbar Start -->
    <th:block th:replace="/layout/navbar/navbar :: navbar"/>


    <!-- ========== Left Sidebar Start ========== -->
    <th:block th:replace="/layout/left-side-bar :: left-side-menu"/>
    <!-- Left Sidebar End -->

    <!-- ============================================================== -->
    <!-- Start Page Content here -->
    <!-- ============================================================== -->

    <div class="content-page">
        <div class="content">

            <!-- Start Content-->
            <div class="container-fluid">


                <!-- start page title -->
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-box">
                            <div class="page-title-right">
                                <ol class="breadcrumb m-0">
                                    <li class="breadcrumb-item"><a href="javascript: void(0);">Uplon</a></li>
                                    <li class="breadcrumb-item active">Product</li>
                                </ol>
                            </div>
                            <h4 class="page-title">Product</h4>
                        </div>
                    </div>
                </div>
                <!-- end page title -->
                <div class="row">
                    <div class="col-8 float-lg-left">
                        <h2>Danh sách Order</h2>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-12">
                        <table id="tableListOrder" class="table table-hover">
                            <thead class="thead-dark">
                            <tr>
                                <th class="align-middle text-center"></th>
                                <th class="align-middle text-center">#</th>
                                <th class="align-middle text-center">Tên Sản phẩm</th>
                                <th class="align-middle text-center">Thể Loại</th>
                                <th class="align-middle text-center">Tên khách hàng</th>
                                <th class="align-middle text-center">Số lượng</th>
                                <th class="align-middle text-center">Đơn giá</th>
                                <th class="align-middle text-center">Tổng tiền</th>
                                <th class="align-middle text-center">Địa chỉ</th>
                                <th class="align-middle text-center">Người tạo</th>
                                <th class="align-middle text-center">Status</th>
                                <th class="align-middle text-center" colspan="2">Công cụ</th>
                            </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- end row -->

            </div> <!-- end container-fluid -->

        </div> <!-- end content -->


        <!-- Footer Start -->
        <footer class="footer">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-12">
                        2016 - 2019 &copy; Uplon theme by <a href="">Coderthemes</a>
                    </div>
                </div>
            </div>
        </footer>
        <!-- end Footer -->

    </div>

    <!-- ============================================================== -->
    <!-- End Page content -->
    <!-- ============================================================== -->

</div>

<th:block th:replace="/layout/script/script :: script"/>

<th:block th:replace="/product/modal-create-product :: modal-create-product"/>

<th:block th:replace="/product/modal-update-product :: modal-update-product"/>

<th:block th:replace="/order/viewOrder::viewOrder"/>

<script>
    let order = new Order();

    let product = new Product();
    let orderItem = new OrderItem();
    let customerInfo = new CustomerInfo();
    let category = new Category();

    function LoadingAllOrder() {
        $.ajax({
            "type": "GET",
            "url": "http://localhost:8080/api/order/allorder"
        }).done((data) => {
            console.log(data)
            $.each(data, (i, item) => {
                order = item;
                let str = `
            <tr id="tr_${order.id}">
                <td class="align-middle text-center"></td>
                <td class="align-middle text-center">${order.id}</td>
                <td class="align-middle text-center " >${order.orderItem.product.productName}</td>
                <td class="align-middle text-center" >${order.orderItem.product.category.name}</td>
                <td class="align-middle text-center" >${order.customerInfo.fullName}</td>
                <td class="align-middle text-center">${order.orderItem.quantityOrdered}</td>
                <td class="align-middle text-center">${new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'VND'
                }).format(order.orderItem.product.priceProduct)}</td>
                <td class="align-middle text-center">${new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'VND'
                }).format(order.orderItem.grandTotal)}</td>
                <td class="align-middle text-center">${order.customerInfo.address}</td>
                <td class="align-middle text-center">${order.user.username}</td>
                <td class="align-middle text-center"><b> ${order.status}</b></td>
                <td class="align-middle text-center "><button data-id="${order.id}" class="btn btn-warning btn_View"  id="btn_View"><i class="fa-solid fa-eye"></i></button></td>
                 <td class="align-middle text-center "><button data-id="${order.id}" class="btn btn-success btn-CheckOut"  id="btn-CheckOut"><i class="fas fa-shopping-cart"></i></button></td>
            </tr>
            `
                $('#tableListOrder tbody').prepend(str);
                handleShowView();
                doComplete()
            })
        }).fail(() => {
            App.IziToast.showErrorAlert("List Order Trống")
        })
    }

    function getOrderById(orderId) {
        return $.ajax({
            headers: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            "type": "GET",
            "url": "http://localhost:8080/api/order/orders/" + orderId,
        }).done((data) => {
            console.log(data);
            order = data;
        }).fail(() => {
            App.IziToast.showErrorAlert("không tìm được order")
        })
    }

    function handleShowView() {
        $("#btn_View").on("click", function () {
            let id = $(this).data("id")
            getOrderById(id).then(() => {
                $(".OrderBill").html("")
                let str = `
                        <div class="row ">
                        <div class="col-1"></div>
                        <div class="col-10 text-center">
                            <h3>Order #${order.id}</h3>

                            </div>
                             <hr>
                        </div>
                        <div class="col-1"></div>
                        <div class="row">
                            <div class="col-1"></div>
                            <div class="col-5">
                                <div class="row"><label style="font-size: 25px" ><b>OrderInformation</b></label>
                                </div>
                                <div class="row"><label >Ngày hoàn thành đơn : ${order.shippedDate}</label></div>

                                <div class="row"><label >Địa chỉ : ${order.customerInfo.address}</label>
                                </div>
                                <div class="row"><label >Địa chỉ : ${order.status}</label>
                                </div>
                            </div>
                            <div class="col-5">
                                <div class="row"><label style="font-size: 25px" ><b>Account information</b></label>
                                </div>
                                <div class="row"><label >Họ và tên: ${order.customerInfo.fullName}</label>
                                </div>
                                <div class="row"><label >số điện thoại: ${order.customerInfo.phone}</label>
                                </div>
                                <div class="row"><label >Ngày sinh: ${order.customerInfo.birthDate}</label>
                            </div>
                            <div class="col-1"></div>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-1"></div>
                            <div class="col-lg-10">
                                <div class="text-center">
                                    <h3>Ordered Items</h3>
                                </div>
                                <table class="table table-hover">
                                    <thead class="thead-light">
                                    <th class="align-middle text-center">#</th>
                                    <th class="align-middle text-center">Image</th>
                                    <th class="align-middle text-center">tên mô hình</th>
                                    <th class="align-middle text-center">danh mục</th>
                                    <th class="align-middle text-center">số lượng</th>
                                    <th class="align-middle text-center">đơn giá</th>
                                    <th class="align-middle text-center">tổng tiền phải thu</th>
                                    </thead>
                                    <tbody>
                                    <td class="align-middle text-center">${order.orderItem.product.productCode}</td>
                                    <td class="align-middle text-center" ><img width="50px" src="${order.orderItem.product.image}"></td>
                                    <td class="align-middle text-center">${order.orderItem.product.productName}</td>
                                    <td class="align-middle text-center">${order.orderItem.product.category.name}</td>
                                    <td class="align-middle text-center">${order.orderItem.quantityOrdered}</td>
                                    <td class="align-middle text-center">${new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'VND'
                }).format(order.orderItem.product.priceProduct)}</td>
                                     <td class="align-middle text-center">${new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'VND'
                }).format(order.orderItem.grandTotal)}</td>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-1"></div>

                        </div>
                `
                $(".OrderBill").append(str);
                $("#viewOrder").modal("show");
                doComplete()
            })
        })
    }

    function doComplete() {
        $("#btn-CheckOut").on("click", function () {
            let id = $(this).data("id")
            getOrderById(id).then(() => {
                $.ajax({
                    "headers": {
                        "accept": "application/json",
                        "content-type": "application/json"
                    },
                    "type": "PUT",
                    "url": "http://localhost:8080/api/order/update",
                    "data": JSON.stringify(order)
                }).done((data) => {
                    order = data
                    let currentRow = $('#tr_' + order.id)
                    let str = `
                                <tr id="tr_${order.id}">
                                    <td class="align-middle text-center"></td>
                                    <td class="align-middle text-center">${order.id}</td>
                                    <td class="align-middle text-center " >${order.orderItem.product.productName}</td>
                                    <td class="align-middle text-center" >${order.orderItem.product.category.name}</td>
                                    <td class="align-middle text-center" >${order.customerInfo.fullName}</td>
                                    <td class="align-middle text-center">${order.orderItem.quantityOrdered}</td>
                                    <td class="align-middle text-center">${new Intl.NumberFormat('vi-VN', {
                        style: 'currency',
                        currency: 'VND'
                    }).format(order.orderItem.product.priceProduct)}</td>
                                    <td class="align-middle text-center">${new Intl.NumberFormat('vi-VN', {
                        style: 'currency',
                        currency: 'VND'
                    }).format(order.orderItem.grandTotal)}</td>
                                    <td class="align-middle text-center">${order.customerInfo.address}</td>
                                    <td class="align-middle text-center">${order.user.username}</td>
                                    <td class="align-middle text-center"><b> ${order.status}</b></td>
                                    <td class="align-middle text-center "><button data-id="${order.id}" class="btn btn-warning btn_View"  id="btn_View"><i class="fa-solid fa-eye"></i></button></td>
                                     <td class="align-middle text-center "><button data-id="${order.id}" class="btn btn-success btn-CheckOut"  id="btn-CheckOut"><i class="fas fa-shopping-cart"></i></button></td>
                                </tr>
                               `
                    currentRow.replaceWith(str);
                    doComplete()
                    handleShowView()
                    App.IziToast.showSuccessAlert("Thay đổi trạng thái thành công")
                }).fail(() => {
                    App.IziToast.showErrorAlert("Thay đổi trạng thái thất bại")
                })
            })

        })
    }

    doComplete()
    handleShowView()
    LoadingAllOrder()
</script>

</body>
</html>