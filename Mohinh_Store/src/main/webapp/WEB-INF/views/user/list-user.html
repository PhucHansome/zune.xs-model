<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <th:block th:replace="/layout/header :: header"/>
    <title>Dashboard | Uplon - Responsive Bootstrap 4 Admin Dashboard</title>

</head>

<body>

<!-- Begin page -->
<div id="wrapper">


    <!-- Topbar Start -->
    <th:block th:replace="/layout/navbar/navbar :: navbar"/>


    <!-- ========== Left Sidebar Start ========== -->
    <th:block th:replace="/layout/left-side-bar :: left-side-menu"/>
    <!-- Left Sidebar End -->

    <!-- ============================================================== -->
    <!-- Start Page Content here -->
    <!-- ============================================================== -->

    <div class="content-page">
        <div class="content">

            <!-- Start Content-->
            <div class="container-fluid">

                <!-- start page title -->
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-box">
                            <div class="page-title-right">
                                <ol class="breadcrumb m-0">
                                    <li class="breadcrumb-item"><a href="javascript: void(0);">Uplon</a></li>
                                    <li class="breadcrumb-item active">User</li>
                                </ol>
                            </div>
                            <h4 class="page-title">User</h4>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-8 float-lg-left">
                        <h2>List User</h2>
                    </div>
                    <div class="col-4 float-lg-right">
                        <button type="button" style="margin-bottom: 10px" id="modalAdd"
                                class="btn btn-outline-primary float-right  modalAdd">
                            <i class="fa fa-plus" aria-hidden="true"></i>
                            Create User
                        </button>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-12">
                        <table id="tableListUsers" class="table table-hover">
                            <thead class="thead-dark">
                            <tr>
                                <th></th>
                                <th>#</th>
                                <th>EMAIL</th>
                                <th>ROLE</th>
                                <th>STATUS</th>
                                <th colspan="3">ACTION</th>
                            </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- end container-fluid -->

        </div> <!-- end content -->


        <!-- Footer Start -->
        <footer class="footer">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-12">
                        2016 - 2019 &copy; Uplon theme by <a href="">Coderthemes</a>
                    </div>
                </div>
            </div>
        </footer>
        <!-- end Footer -->

    </div>

    <!-- ============================================================== -->
    <!-- End Page content -->
    <!-- ============================================================== -->

</div>

<th:block th:replace="/layout/script/script :: script"/>

<th:block th:replace="/user/modal-change-password :: modal-change-password"/>

<th:block th:replace="/user/modal-create-information :: modal-create-information"/>

<script>

    let user = new User();

    let role = new Role();

    let userId = null;

    function LoadingAllUser() {
        $.ajax({
            "type": "GET",
            "url": "http://localhost:8080/api/user"
        }).done((data) => {
            console.log(data)
            $.each(data, (i, item) => {
                console.log(item.role.code);
                let str =
                    `
                     <tr id="tr_${item.id}">
                        <td></td>
                        <td>${item.id}</td>
                        <td>${item.username}</td>
                        <td><b>${item.role.code}</b></td>
                        <td><b>${item.status}</b></td>
                        <td>
                        <button data-id="${item.id}" style="margin-right: 10px" class="btn btn-outline-success" id="btn-active">Active</button>
                        <button class="btn btn-outline-danger" data-id="${item.id}" id="btn-block">block</button>
                        <button type="button" data-id="${item.id}" id="btnChangePassWord" class="btn btn-outline-primary btnChangePassWord">
                            <i class="fa fa-plus" aria-hidden="true"></i>
                        </button></td>
                    </tr>
                    `
                $('#tableListUsers tbody').prepend(str);
                handleShowCreateModal();
                handleShowUpdatePassWord();
                handleActive();
                handleBlock();
            })
        }).fail(() => {
            App.SweetAlert.showErrorAlert("Customer Errors")
        })
    }

    function getUserById(userId) {
        return $.ajax({
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            "type": "GET",
            url: "http://localhost:8080/api/user/" + userId
        }).done((data) => {
            user = data;
        }).fail((jqXHR) => {
            App.SweetAlert.showErrorAlert("fail id customer");
            console.log(jqXHR);
        })
    }

    $("#btnCreate").on("click", function () {
        $("#frmCreateCustomer").submit();
    })

    $("#btnUpdatePassword").on("click", () => {
        $("#frmUpdatePassword").submit();
    })

    function handleShowCreateModal() {
        $("#modalAdd").on("click", () => {
            $("#modalCreateUser").modal('show');
        })
    }

    function handleShowUpdatePassWord() {
        $("#btnChangePassWord").on("click", function () {
            let id = $(this).data("id");
            getUserById(id).then(() => {
                $("#modalUpdatePassword").modal("show");
                $("#idUser").val(user.id);
            })
        })
    }

    function handleActive() {
        $("#btn-active").on("click", function () {
            let id = $(this).data("id");
            getUserById(id).then(() => {
                $.ajax({
                    headers: {
                        "accept": "application/json",
                        "content-type": "application/json"
                    },
                    type: "PUT",
                    url: "http://localhost:8080/api/user/active",
                    data: JSON.stringify(user)
                }).done((data) => {
                    user = data;
                    let currentRow = $('#tr_' + user.id);
                    let updateRow = `

                     <tr id="tr_${user.id}">
                        <td></td>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td><b>${user.role.code}</b></td>
                        <td>${user.status}</td>
                        <td>
                        <button data-id="${user.id}" style="margin-right: 10px" class="btn btn-outline-success" id="btn-active">Active</button>
                        <button class="btn btn-outline-danger" data-id="${user.id}" id="btn-block">block</button>
                        <button type="button" data-id="${user.id}" id="btnChangePassWord" class="btn btn-outline-primary btnChangePassWord">
                            <i class="fa fa-plus" aria-hidden="true"></i>
                        </button></td>
                    </tr>
            `
                    App.IziToast.showSuccessAlert("Tài Khoản đã được Active!");
                    currentRow.replaceWith(updateRow);
                    handleShowUpdatePassWord()
                    handleShowCreateModal()
                    handleActive();
                    handleBlock();
                }).fail(() => {
                    App.IziToast.showErrorAlert("False")
                })
            })
        })
    }

    function handleBlock() {
        $("#btn-block").on("click", function () {
            let id = $(this).data("id");
            getUserById(id).then(() => {
                $.ajax({
                    headers: {
                        "accept": "application/json",
                        "content-type": "application/json"
                    },
                    type: "PUT",
                    url: "http://localhost:8080/api/user/block",
                    data: JSON.stringify(user)
                }).done((data) => {
                    user = data;
                    let currentRow = $('#tr_' + user.id);
                    let updateRow = `

                     <tr id="tr_${user.id}">
                        <td></td>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td><b>${user.role.code}</b></td>
                        <td><b>${user.status}</b></td>
                        <td>
                        <button data-id="${user.id}" style="margin-right: 10px" class="btn btn-outline-success" id="btn-active">Active</button>
                        <button class="btn btn-outline-danger" data-id="${user.id}" id="btn-block">block</button>
                        <button type="button" data-id="${user.id}" id="btnChangePassWord" class="btn btn-outline-primary btnChangePassWord">
                            <i class="fa fa-plus" aria-hidden="true"></i>
                        </button></td>
                    </tr>
            `
                    App.IziToast.showSuccessAlert("Tài khoản đã bị block");
                    currentRow.replaceWith(updateRow);
                    handleShowUpdatePassWord()
                    handleShowCreateModal()
                    handleActive();
                    handleBlock();
                }).fail(() => {
                    App.IziToast.showErrorAlert("False")

                })
            })
        })
    }

    function doCreate() {
        let username = $("#EmailCre").val();
        let passwordCre = $("#passwordCre").val();
        let passwordConCre = $("#passwordConCre").val();
        let roleCode = $("#role :selected").text();
        let roleId = $("#role").val();

        role.id = roleId;
        role.code = roleCode;

        delete user.id
        user.username = username;
        user.password = passwordCre;
        user.role = role
        $.ajax({
            headers: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            type: "POST",
            url: "http://localhost:8080/api/auth/register",
            data: JSON.stringify(user)
        }).done((data) => {
            $("#modalCreateUser").modal('hide');
            App.SweetAlert.showSuccessAlert("Đăng ký thành công!!");

            let str =
                `
                     <tr id="tr_${data.id}">
                        <td></td>
                        <td>${data.id}</td>
                        <td>${data.username}</td>
                        <td><b>${data.role.code}</b></td>
                        <td>${data.status}</td>
                        <td>
                         <button data-id="${data.id}" style="margin-right: 10px" class="btn btn-outline-success" id="btn-active">Active</button>
                        <button class="btn btn-outline-danger" data-id="${data.id}" id="btn-block">block</button>
                        <button type="button" data-id="${data.id}" id="btnChangePassWord" class="btn btn-outline-primary btnChangePassWord">
                            <i class="fa fa-plus" aria-hidden="true"></i>
                        </button>
                        </td>
                    </tr>
                    `
            $('#tableListUsers tbody').prepend(str);
            $("#EmailCre").val("")
            $("#passwordCre").val("")
            $("#passwordConCre").val()
            handleShowCreateModal();
            handleShowUpdatePassWord()
            handleBlock()
            handleActive()

        }).fail((jqXHR) => {
            $('#modalCreateUser .modal-alert-danger ').html('').removeClass('hide').addClass('show');
            if (jqXHR.responseJSON.message) {
                let msg = jqXHR.responseJSON.message;
                let str = `<label for="message" id="message-error" class="error">${msg}</label>`
                $('#modalCreateUser .modal-alert-danger').append(str)
            } else if (jqXHR.responseJSON) {
                let str = '';
                $.each(jqXHR.responseJSON, (key, item) => {
                    str += `<label for="${key}" id="${key}-error" class="error">${item}</label><br>`;
                    $('#modalCreateUser .modal-alert-danger').append(str);
                })

            }
        })
    }

    function doUpdatePassword() {
        let password = $("#passwordUp").val();

        user.id = $("#idUser").val();
        user.password = password;
        $.ajax({
            headers: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            type: "PUT",
            url: "http://localhost:8080/api/user/update",
            data: JSON.stringify(user)
        }).done(() => {
            App.SweetAlert.showSuccessAlert("Bạn đã đổi mật khẩu thành công!!")
        }).fail((jqXHR) => {
            $('#modalUpdatePassword .modal-alert-danger').html('').removeClass('hide').addClass('show');
            if (jqXHR.responseJSON.message) {
                let msg = jqXHR.responseJSON.message;
                let str = `<label for="message" id="message-error" class="error">${msg}</label>`
                $('#modalUpdatePassword .modal-alert-danger').append(str)
            } else if (jqXHR.responseJSON) {
                let str = '';
                $.each(jqXHR.responseJSON, (key, item) => {
                    str += `<label for="${key}" id="${key}-error" class="error">${item}</label><br>`;
                    $('#modalUpdatePassword .modal-alert-danger').append(str);
                })
            }
        })
    }

    $('#frmCreateCustomer').validate({
        "rules": {
            "EmailCre": {
                required: true,
                email: true,
                minlength: 3,
                maxlength: 50,
            },
            "passwordCre": {
                required: true,
                minlength: 6,
                maxlength: 30,
            },
            "passwordConCre": {
                required: true,
                equalTo: "#passwordCre",
                minlength: 6,
                maxlength: 30,
            }
        },
        "messages": {
            "EmailCre": {
                required: "vui lòng nhập Email!",
                email: "Vui lòng nhập đúng định dạng Email (VD: phucnguyen@gmail.com)!",
                minlength: $.validator.format("Email tối thiểu {0} ký tự!"),
                maxlength: $.validator.format("Email tối đa {0} ký tự"),
            },
            "passwordCre": {
                required: "Vui lòng nhập Password",
                minlength: $.validator.format("Password tối thiểu {0} ký tự!"),
                maxlength: $.validator.format("Password tối đa {0} ký tự!"),
            }
            ,
            "passwordConCre": {
                required: "Vui lòng nhập Password Confirm",
                equalTo: "Mật khẩu phải giống nhau",
                minlength: $.validator.format("Password tối thiểu {0} ký tự!"),
                maxlength: $.validator.format("Password tối đa {0} ký tự!"),
            }
        },
        errorLabelContainer: "#modalCreateUser .modal-alert-danger",
        errorPlacment: function (error, element) {
            error.appendTo("#modalCreateUser .modal-alert-danger")
        },
        showErrors: function (errorMap, errorList) {
            if (this.numberOfInvalids() > 0) {
                $("#modalCreateUser .modal-alert-danger").removeClass("hide").addClass("show");
            } else {
                $("#modalCreateUser .modal-alert-danger").removeClass("show").addClass("hide").empty();
                $("#frmCreateCustomer .input.error").removeClass("error");
            }
            this.defaultShowErrors();
        },
        submitHandler: function () {
            doCreate();
        }
    })

    $('#frmUpdatePassword').validate({
        "rules": {
            "passwordUp": {
                required: true,
                minlength: 3,
                maxlength: 50,
            },
            "passwordConUp": {
                required: true,
                equalTo: "#passwordUp",
                minlength: 6,
                maxlength: 30,
            }
        },
        "messages": {
            "passwordUp": {
                required: "Vui lòng nhập Password!",
                minlength: $.validator.format("Password tối thiểu {0} ký tự!"),
                maxlength: $.validator.format("Password tối đa {0} ký tự"),
            },
            "passwordConUp": {
                required: "Vui lòng nhập Password Confirm",
                equalTo: "Mật khẩu phải giống nhau",
                minlength: $.validator.format("Password Confirm tối thiểu {0} ký tự!"),
                maxlength: $.validator.format("Password Confirm tối đa {0} ký tự!"),
            }
        },
        errorLabelContainer: "#modalUpdatePassword .modal-alert-danger",
        errorPlacment: function (error, element) {
            error.appendTo("#modalUpdatePassword .modal-alert-danger")
        },
        showErrors: function (errorMap, errorList) {
            if (this.numberOfInvalids() > 0) {
                $("#modalUpdatePassword .modal-alert-danger").removeClass("hide").addClass("show");
            } else {
                $("#modalUpdatePassword .modal-alert-danger").removeClass("show").addClass("hide").empty();
                $("#frmUpdatePassword .input.error").removeClass("error");
            }
            this.defaultShowErrors();
        },
        submitHandler: function () {
            doUpdatePassword();
        }
    })

    handleShowUpdatePassWord()
    handleShowCreateModal()
    LoadingAllUser();
    handleActive();
    handleBlock();
</script>

</body>
</html>